import{r as e,j as t,S as r,M as s,c as a,X as n,d as l,e as o,f as c}from"./index-Bg1WC_Fo.js";import{k as i}from"./markdown-BVW4aYY-.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";import"./react-vendor-B_uAldPx.js";i.setOptions({breaks:!0,gfm:!0});const m=({currentBook:m,selectedChapterIndex:d,onClose:u})=>{const[x,h]=e.useState([]),[p,b]=e.useState(""),[g,f]=e.useState(!1),[j,y]=e.useState(!1),[w,N]=e.useState("current-chapter"),[v,C]=e.useState(!1),[$,S]=e.useState(null),[k,A]=e.useState(""),[E,T]=e.useState(!1),F=e.useRef(null),z=e.useRef(null);e.useEffect(()=>{F.current?.scrollIntoView({behavior:"smooth"})},[x,k]),e.useEffect(()=>{!g&&x.length>0&&z.current?.focus()},[g,x.length]);const I=async()=>{if(!p.trim()||g)return;const e={role:"user",content:p.trim()},t=0===x.length;h(t=>[...t,e]),b(""),f(!0),S(null),A("");try{const r=(()=>{const{chapters:e,summaries:t}=m;switch(w){case"current-chapter":return`Chapter ${d+1}: ${e[d].title}\n\n${e[d].content}`;case"up-to-current":{let t="";for(let r=0;r<=d;r++)t+=`\n\n=== Chapter ${r+1}: ${e[r].title} ===\n\n${e[r].content}`;return t}case"all-chapters":{let t="";return e.forEach((e,r)=>{t+=`\n\n=== Chapter ${r+1}: ${e.title} ===\n\n${e.content}`}),t}case"all-summaries":{let r="";return e.forEach((e,s)=>{const a=t[s];a?(r+=`\n\n=== Chapter ${s+1}: ${e.title} ===\nSummary:\n`,a.bullets.forEach(e=>{r+=`- ${e}\n`}),a.quote&&(r+=`Quote: "${a.quote}"\n`)):r+=`\n\n=== Chapter ${s+1}: ${e.title} ===\n(Not yet summarized)\n`}),r}case"summaries-up-to-current":{let r="";for(let s=0;s<=d;s++){const a=t[s];a?(r+=`\n\n=== Chapter ${s+1}: ${e[s].title} ===\nSummary:\n`,a.bullets.forEach(e=>{r+=`- ${e}\n`}),a.quote&&(r+=`Quote: "${a.quote}"\n`)):r+=`\n\n=== Chapter ${s+1}: ${e[s].title} ===\n(Not yet summarized)\n`}return r+=`\n\n=== Current Chapter (Full Text) ===\nChapter ${d+1}: ${e[d].title}\n\n${e[d].content}`,r}default:return""}})(),s=await c([...x,e],r,t,v,d+1);let a="";for await(const e of s)a+=e.text,A(a);h(e=>[...e,{role:"assistant",content:a}]),A("")}catch(r){const e=r instanceof Error?r.message:"An unknown error occurred.";S(e),A("")}finally{f(!1)}},q=e=>{switch(e){case"current-chapter":return"Current Chapter (Full Text)";case"up-to-current":return"All Chapters Up to Current (Full Text)";case"all-chapters":return"All Chapters (Full Text)";case"all-summaries":return"All Chapter Summaries";case"summaries-up-to-current":return"Summaries + Current Chapter (Full Text)";default:return""}};return t.jsxs("div",{className:"fixed z-50 flex flex-col bg-gray-800 shadow-2xl border border-amber-900/30 "+(E?"inset-y-0 right-0 w-full md:w-[600px] rounded-none":"inset-0 md:inset-auto md:bottom-4 md:right-4 md:w-[450px] md:h-[600px] rounded-none md:rounded-lg"),children:[t.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-amber-900/20 bg-gray-900/50",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("h3",{className:"text-lg font-bold text-amber-400",children:"Chat with Gemini"}),t.jsx("button",{onClick:()=>y(!j),className:"p-1 text-gray-400 hover:text-amber-400 transition-colors","aria-label":"Settings",children:t.jsx(r,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>T(!E),className:"hidden md:block p-1 text-gray-400 hover:text-amber-400 transition-colors","aria-label":E?"Minimize":"Maximize",children:E?t.jsx(s,{className:"w-5 h-5"}):t.jsx(a,{className:"w-5 h-5"})}),t.jsx("button",{onClick:u,className:"p-1 text-gray-400 hover:text-amber-400 transition-colors","aria-label":"Close chat",children:t.jsx(n,{className:"w-6 h-6"})})]})]}),j&&t.jsxs("div",{className:"p-4 border-b border-amber-900/20 bg-gray-900/30 space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-semibold text-amber-400/90 mb-2",children:"Context:"}),t.jsxs("select",{value:w,onChange:e=>N(e.target.value),className:"w-full bg-gray-700 text-gray-100 border border-amber-900/30 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500",children:[t.jsx("option",{value:"current-chapter",children:"Current Chapter (Full Text)"}),t.jsx("option",{value:"summaries-up-to-current",children:"Summaries + Current Chapter"}),t.jsx("option",{value:"up-to-current",children:"All Chapters Up to Current"}),t.jsx("option",{value:"all-summaries",children:"All Chapter Summaries"}),t.jsx("option",{value:"all-chapters",children:"All Chapters (Full Text)"})]}),t.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Current: ",q(w)]})]}),t.jsxs("div",{className:"pt-2 border-t border-amber-900/20",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:v,onChange:e=>C(e.target.checked),className:"w-4 h-4 rounded border-amber-900/30 bg-gray-700 text-amber-600 focus:ring-2 focus:ring-amber-500"}),t.jsx("span",{className:"text-sm font-semibold text-amber-400/90",children:"Allow Spoilers"})]}),t.jsx("p",{className:"text-xs text-gray-400 mt-1 ml-6",children:v?"⚠️ AI can reveal future events":"✓ AI will only discuss up to chapter "+(d+1)})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 chatbot-messages",children:[0===x.length&&t.jsxs("div",{className:"text-center text-gray-400 py-8",children:[t.jsx("p",{className:"text-lg font-semibold text-amber-400/80 mb-2",children:"Start a conversation"}),t.jsx("p",{className:"text-sm",children:"Ask questions about the book, characters, themes, or events."}),t.jsxs("p",{className:"text-xs mt-4",children:["Using context: ",q(w)]})]}),x.map((e,r)=>t.jsx("div",{className:"flex "+("user"===e.role?"justify-end":"justify-start"),children:t.jsx("div",{className:"max-w-[85%] px-4 py-2 rounded-lg "+("user"===e.role?"bg-amber-600 text-white":"bg-gray-700 text-gray-100"),children:"user"===e.role?t.jsx("p",{className:"whitespace-pre-wrap break-words text-sm",children:e.content}):t.jsx("div",{className:"prose prose-sm prose-invert max-w-none break-words",dangerouslySetInnerHTML:{__html:i(e.content)}})})},r)),k&&t.jsx("div",{className:"flex justify-start",children:t.jsx("div",{className:"bg-gray-700 text-gray-100 px-4 py-2 rounded-lg max-w-[85%]",children:t.jsx("div",{className:"prose prose-sm prose-invert max-w-none break-words",dangerouslySetInnerHTML:{__html:i(k)}})})}),g&&!k&&t.jsx("div",{className:"flex justify-start",children:t.jsx("div",{className:"bg-gray-700 text-gray-100 px-4 py-2 rounded-lg",children:t.jsx(l,{className:"w-5 h-5 text-amber-400 animate-spin"})})}),t.jsx("div",{ref:F})]}),$&&t.jsx("div",{className:"px-4 py-2 bg-red-900/30 border-t border-red-900/50",children:t.jsx("p",{className:"text-sm text-red-400",children:$})}),t.jsxs("div",{className:"p-4 border-t border-amber-900/20 bg-gray-900/30",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx("textarea",{ref:z,value:p,onChange:e=>b(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),I())},placeholder:"Ask about the book...",disabled:g,className:"flex-1 bg-gray-700 text-gray-100 border border-amber-900/30 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none disabled:opacity-50 disabled:cursor-not-allowed",rows:2}),t.jsx("button",{onClick:I,disabled:!p.trim()||g,className:"self-end p-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed disabled:opacity-50","aria-label":"Send message",children:t.jsx(o,{className:"w-5 h-5"})})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Press Enter to send, Shift+Enter for new line"})]})]})};export{m as default};
